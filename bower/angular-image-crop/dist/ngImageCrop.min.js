!function(a,b){"use strict";b.module("ngImageCrop",[]).directive("imageCropDirective",[function(){return{restrict:"ACE",scope:{imageData:"=imageData",doCropping:"&doCropping",doLoadImage:"&doLoadImage"},template:'<canvas oncontextmenu="return false;" style="border: 1px solid #c9c9c9"></canvas>',link:function(a,b,c){function d(){$(j).on("mousedown",function(a){r.cropping=a.ctrlKey,r.mouseDown=!0;var b=a.offsetX||a.pageX-$(a.target).offset().left,c=a.offsetY||a.pageY-$(a.target).offset().top;r.cropping?(r.startDragOffset.x=b,r.startDragOffset.y=c):(r.startDragOffset.x=b-l.x,r.startDragOffset.y=c-l.y),a.preventDefault(),h()});var b=function(a){r.mouseDown=!1,r.cropping=!1,a.preventDefault()};$(j).on("mouseup",function(b){if(r.cropping){var c=r.startDragOffset.x,d=r.startDragOffset.y,e=b.offsetX||b.pageX-$(b.target).offset().left,f=b.offsetY||b.pageY-$(b.target).offset().top,g=document.createElement("canvas");g.style.background="#ffffff",g.width=j.width/m,g.height=j.height/m;var h=g.getContext("2d"),n={x:l.x/m,y:l.y/m},p=o;h.clearRect(0,0,n.width,n.height),h.save(),h.translate(n.x,n.y),h.rotate(p*Math.PI/180),h.drawImage(q,k.width/-2,k.height/-2,k.width,k.height),h.restore();var s=c/m,t=d/m,u=e/m,v=f/m,w=Math.abs(u-s),x=Math.abs(v-t);if(w>0&&x>0){i={startX:c,startY:d,offsetX:e,offsetY:f};var y=h.getImageData(Math.min(s,u),Math.min(t,v),w,x),z=y.height,A=y.width,B=document.createElement("canvas");B.width=A,B.height=z;var C=B.getContext("2d");C.putImageData(y,0,0);var D=B.toDataURL("image/jpeg");a.$apply(function(a){a.doCropping({$imageData:D,$imageType:"JPG"})})}}r.mouseDown=!1,r.cropping=!1,b.preventDefault()}),$(j).on("mouseover",b),$(j).on("mouseout",b),$(j).on("mousemove",function(a){if(r.mouseDown){var b=a.offsetX||a.pageX-$(a.target).offset().left,c=a.offsetY||a.pageY-$(a.target).offset().top;if(r.cropping)h(b,c);else{var d={x:b-r.startDragOffset.x,y:c-r.startDragOffset.y};i&&(i={startX:i.startX+d.x-l.x,startY:i.startY+d.y-l.y,offsetX:i.offsetX+d.x-l.x,offsetY:i.offsetY+d.y-l.y}),g(m,d)}}}),$.fn.mousewheel&&$(j).on("mousewheel",function(a){a.preventDefault();var b=m;if(a.deltaY<0?b/=p:b*=p,b>=(n+"").substring(0,(n+"").length-2)&&8>b){var c=a.offsetX||a.pageX-$(a.target).offset().left,d=a.offsetY||a.pageY-$(a.target).offset().top;l.x-=(c-l.x)*(b-m)/m,l.y-=(d-l.y)*(b-m)/m,i&&(i={startX:i.startX-(c-i.startX)*(b-m)/m,startY:i.startY-(d-i.startY)*(b-m)/m,offsetX:i.offsetX-(c-i.offsetX)*(b-m)/m,offsetY:i.offsetY-(d-i.offsetY)*(b-m)/m}),g(b)}})}function e(a,b){a>=(n+"").substring(0,(n+"").length-2)&&8>a&&(m=a),b||(b={x:l.x,y:l.y}),b&&(l.x=b.x,l.y=b.y)}function f(a){void 0!=a&&(l.x=j.width/2,l.y=j.height/2,o=a)}function g(a,b,c){e(a,b),f(c),h()}function h(a,b,c){var d=j.getContext("2d");d.clearRect(0,0,j.width,j.height),d.save(),d.translate(l.x,l.y),d.scale(m,m),d.rotate(o*Math.PI/180),d.drawImage(q,k.width/-2,k.height/-2,k.width,k.height),d.restore(),a&&b&&(d.strokeStyle="#0000ff",d.fillStyle="rgba(0,0,255,0.05)",d.beginPath(),d.rect(Math.min(a,r.startDragOffset.x),Math.min(b,r.startDragOffset.y),Math.abs(a-r.startDragOffset.x),Math.abs(b-r.startDragOffset.y)),d.fillRect(Math.min(a,r.startDragOffset.x),Math.min(b,r.startDragOffset.y),Math.abs(a-r.startDragOffset.x),Math.abs(b-r.startDragOffset.y)),d.stroke())}var i,j=$(b).find("canvas")[0];j.width=c.width,j.height=c.height;var k={width:0,height:0},l={x:0,y:0},m=1,n=.1,o=0,p=1.2,q=new Image;q.onload=function(){k.width=q.width,k.height=q.height,m=Math.min(j.width/k.width,j.height/k.height),n=m,o=0,i=null,l={x:j.width/2,y:j.height/2},f(o),g(m,l),a.$apply(function(a){a.doLoadImage({$imageSrc:q.src})})},q.onerror=function(a){};var r={mouseDown:!1,startDragOffset:{},cropping:!1};d(),a.$watch("imageData",function(b,c){a.imageData&&a.imageData.data&&(q.crossOrigin="Anonymous",q.src=a.imageData.data)})}}}])}(window,angular);